import { describe, it, expect, beforeEach } from 'vitest';
{{#if redux}}
import { useSelector, useDispatch } from 'react-redux';
import { store } from '../store/store';
import { toggleTheme, setTheme, selectTheme } from '../store/slices/appSlice';
{{else}}
import { useState } from 'react';
{{/if}}
{{#if reactRouter}}
import { Routes, Route, Link } from 'react-router-dom';
import { renderApp, screen, waitFor, userEvent } from '../test/test-utils';
{{else}}
import { renderApp, screen, userEvent } from '../test/test-utils';
{{/if}}

// Integration test component
function ThemeToggler() {
  {{#if redux}}
  const theme = useSelector(selectTheme);
  const dispatch = useDispatch();

  return (
    <div>
      <span data-testid="theme">{theme}</span>
      <button onClick={() => dispatch(toggleTheme())} data-testid="toggle">Toggle</button>
      <button onClick={() => dispatch(setTheme('light'))} data-testid="set-light">Light</button>
      <button onClick={() => dispatch(setTheme('dark'))} data-testid="set-dark">Dark</button>
    </div>
  );
  {{else}}
  const [theme, setThemeState] = useState('dark');

  return (
    <div>
      <span data-testid="theme">{theme}</span>
      <button onClick={() => setThemeState(t => t === 'dark' ? 'light' : 'dark')} data-testid="toggle">Toggle</button>
      <button onClick={() => setThemeState('light')} data-testid="set-light">Light</button>
      <button onClick={() => setThemeState('dark')} data-testid="set-dark">Dark</button>
    </div>
  );
  {{/if}}
}

{{#if redux}}
describe('Redux Integration', () => {
  beforeEach(() => {
    store.dispatch(setTheme('dark'));
  });

  describe('ThemeToggler Component with Redux', () => {
    it('should display initial theme', () => {
      renderApp(<ThemeToggler />);
      expect(screen.getByTestId('theme')).toHaveTextContent('dark');
    });

    it('should toggle theme on button click', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('toggle'));
      expect(screen.getByTestId('theme')).toHaveTextContent('light');
    });

    it('should set theme to light', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('set-light'));
      expect(screen.getByTestId('theme')).toHaveTextContent('light');
    });

    it('should set theme to dark', async () => {
      const user = userEvent.setup();
      store.dispatch(setTheme('light'));
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('set-dark'));
      expect(screen.getByTestId('theme')).toHaveTextContent('dark');
    });

    it('should handle multiple toggles', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      const toggleBtn = screen.getByTestId('toggle');
      await user.click(toggleBtn); // dark -> light
      await user.click(toggleBtn); // light -> dark
      await user.click(toggleBtn); // dark -> light

      expect(screen.getByTestId('theme')).toHaveTextContent('light');
    });
  });

  {{#if reactRouter}}
  describe('Redux with Router Integration', () => {
    function ThemePage() {
      return (
        <div>
          <h1>Theme Page</h1>
          <ThemeToggler />
          <Link to="/other" data-testid="other-link">Go to Other</Link>
        </div>
      );
    }

    function OtherPage() {
      return (
        <div>
          <h1>Other Page</h1>
          <Link to="/" data-testid="theme-link">Go to Theme</Link>
        </div>
      );
    }

    function AppWithRouter() {
      return (
        <Routes>
          <Route path="/" element={<ThemePage />} />
          <Route path="/other" element={<OtherPage />} />
        </Routes>
      );
    }

    it('should persist Redux state across navigation', async () => {
      const user = userEvent.setup();
      renderApp(<AppWithRouter />, { route: '/' });

      // Toggle theme
      await user.click(screen.getByTestId('toggle'));
      expect(screen.getByTestId('theme')).toHaveTextContent('light');

      // Navigate away
      await user.click(screen.getByTestId('other-link'));
      await waitFor(() => {
        expect(screen.queryByTestId('theme')).not.toBeInTheDocument();
      });

      // Navigate back
      await user.click(screen.getByTestId('theme-link'));
      await waitFor(() => {
        expect(screen.getByTestId('theme')).toHaveTextContent('light');
      });
    });
  });
  {{/if}}
});
{{else}}
describe('Component Integration', () => {
  describe('ThemeToggler Component', () => {
    it('should display initial theme', () => {
      renderApp(<ThemeToggler />);
      expect(screen.getByTestId('theme')).toHaveTextContent('dark');
    });

    it('should toggle theme on button click', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('toggle'));
      expect(screen.getByTestId('theme')).toHaveTextContent('light');
    });

    it('should set theme to light', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('set-light'));
      expect(screen.getByTestId('theme')).toHaveTextContent('light');
    });

    it('should set theme to dark', async () => {
      const user = userEvent.setup();
      renderApp(<ThemeToggler />);

      await user.click(screen.getByTestId('toggle'));
      await user.click(screen.getByTestId('set-dark'));
      expect(screen.getByTestId('theme')).toHaveTextContent('dark');
    });
  });
});
{{/if}}
